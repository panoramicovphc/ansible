name: "Publish Ansible project"
run-name: "${{ github.event_name }} by ${{ github.actor }} #${{ github.run_number }}.${{ github.run_attempt }}"

on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main", "dev" ]
  workflow_dispatch:
    inputs:
      reason:
        description: "Reason for running the workflow"
        required: true
        default: "Manual trigger"

jobs:

  publish-artifact:
    name: "Build & Publish Artifacts"
    runs-on: [ "ubuntu-24.04" ]
    steps:
      - name: "Checkout repository"
        uses: "actions/checkout@v2"
      - name: "Build hosts.ini"
        env:
          TANKIAN_USER_LOGIN: "${{ vars.TANKIAN_USER_LOGIN }}"
          TANKIAN_USER_PASSWORD: "${{ secrets.TANKIAN_USER_PASSWORD }}"
          CF_TUNNEL_TOKEN_TANKIAN: "${{ secrets.CF_TUNNEL_TOKEN_TANKIAN }}"
        run: |
          envsubst < inventory/hosts.ini.template > inventory/hosts.ini
      - name: "List artifact"
        run: |
          ls -la
      - name: "Build artifact"
        run: |
          tar --exclude=".git" --exclude=".github" -czf ${RUNNER_TEMP}/artifact-v${{ github.run_number }}.${{ github.run_attempt }}.tar.gz .
      - name: "Verify artifact"
        run: |
          if [ ! -f ${RUNNER_TEMP}/artifact-v${{ github.run_number }}.${{ github.run_attempt }}.tar.gz ]; then
            echo "Artifact was not created successfully."
            exit 1
          fi
      - name: "Upload artifact"
        uses: "actions/upload-artifact@v4"
        with:
          name: "artifact-v${{ github.run_number }}.${{ github.run_attempt }}"
          if-no-files-found: error
          path: ${RUNNER_TEMP}/artifact-v${{ github.run_number }}.${{ github.run_attempt }}.tar.gz
